import React, { useState, useEffect } from 'react';
import { Calculator, User, Target, TrendingDown, TrendingUp, Minus, Droplets, History, Trash2, Calendar, ChefHat } from 'lucide-react';

export default function MetabolicCalculator() {
  const [formData, setFormData] = useState({
    age: '', taille: '', poids: '', sexe: 'homme',
    masseMusculaire: '', masseOsseuse: '', masseHydrique: '',
    masseGraisseuse: '', graisseViscerale: '', ageMetabolique: '',
    objectif: 'maintien', activite: 'sedentaire'
  });

  const [results, setResults] = useState(null);
  const [historique, setHistorique] = useState([]);
  const [showHistorique, setShowHistorique] = useState(false);
  const [showRecettes, setShowRecettes] = useState(false);

  const recettesProteinees = [
    {
      nom: "Omelette aux blancs d'≈ìufs",
      proteines: "25g",
      calories: "180 kcal",
      ingredients: "4 blancs d'≈ìufs, 1 ≈ìuf entier, l√©gumes, fromage all√©g√©",
      preparation: "Battre les ≈ìufs, ajouter les l√©gumes, cuire √† la po√™le 5 min"
    },
    {
      nom: "Poulet grill√© aux √©pices",
      proteines: "35g",
      calories: "200 kcal",
      ingredients: "150g de poulet, paprika, cumin, citron",
      preparation: "Assaisonner le poulet, griller 12-15 min, servir avec citron"
    },
    {
      nom: "Yaourt grec prot√©in√©",
      proteines: "20g",
      calories: "150 kcal",
      ingredients: "200g yaourt grec 0%, fruits rouges, miel",
      preparation: "M√©langer le yaourt avec les fruits et 1 cuill√®re de miel"
    },
    {
      nom: "Saumon au four",
      proteines: "30g",
      calories: "250 kcal",
      ingredients: "150g de saumon, citron, aneth, huile d'olive",
      preparation: "Badigeonner d'huile, assaisonner, cuire 15 min √† 180¬∞C"
    },
    {
      nom: "Shake prot√©in√© maison",
      proteines: "28g",
      calories: "220 kcal",
      ingredients: "1 scoop whey, 200ml lait, banane, beurre de cacahu√®te",
      preparation: "Mixer tous les ingr√©dients jusqu'√† texture lisse"
    },
    {
      nom: "Thon en salade",
      proteines: "32g",
      calories: "190 kcal",
      ingredients: "1 bo√Æte thon naturel, salade verte, tomates, concombre",
      preparation: "M√©langer le thon √©goutt√© avec les l√©gumes frais"
    },
    {
      nom: "Steak hach√© maigre",
      proteines: "28g",
      calories: "210 kcal",
      ingredients: "150g steak hach√© 5%, oignon, ail, herbes",
      preparation: "Faire revenir avec oignon et ail, cuire 8-10 min"
    },
    {
      nom: "Cottage cheese bowl",
      proteines: "22g",
      calories: "160 kcal",
      ingredients: "150g cottage cheese, noix, myrtilles, cannelle",
      preparation: "Disposer le fromage blanc, ajouter fruits et noix"
    }
  ];

  useEffect(() => {
    const saved = localStorage.getItem('metabolicHistory');
    if (saved) setHistorique(JSON.parse(saved));
  }, []);

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const calculerBesoins = () => {
    const { age, taille, poids, sexe, masseMusculaire, objectif, activite } = formData;
    
    let mb = sexe === 'homme'
      ? 88.362 + (13.397 * parseFloat(poids)) + (4.799 * parseFloat(taille)) - (5.677 * parseFloat(age))
      : 447.593 + (9.247 * parseFloat(poids)) + (3.098 * parseFloat(taille)) - (4.330 * parseFloat(age));

    if (masseMusculaire) {
      const pct = (parseFloat(masseMusculaire) / parseFloat(poids)) * 100;
      if (pct > 45) mb *= 1.1;
      else if (pct < 30) mb *= 0.95;
    }

    const facteurs = { sedentaire: 1.2, leger: 1.375, modere: 1.55, intense: 1.725, treIntense: 1.9 };
    let caloriesJour = mb * facteurs[activite];

    let caloriesFinales, proteines;
    const objMap = {
      perte: [-500, 2.0], perteLente: [-300, 1.8], maintien: [0, 1.6],
      prise: [300, 1.8], priseMasse: [500, 2.2]
    };
    const [calAdj, protFactor] = objMap[objectif] || [0, 1.6];
    caloriesFinales = caloriesJour + calAdj;
    proteines = parseFloat(poids) * protFactor;

    const calProteines = proteines * 4;
    const calLipides = caloriesFinales * 0.25;
    const lipides = calLipides / 9;
    const glucides = (caloriesFinales - calProteines - calLipides) / 4;

    const ajustAct = { sedentaire: 0, leger: 300, modere: 500, intense: 800, treIntense: 1200 };
    let eauBase = parseFloat(poids) * 35 + ajustAct[activite];
    if (objectif === 'perte' || objectif === 'perteLente') eauBase += 250;

    const res = {
      mb: Math.round(mb),
      caloriesJour: Math.round(caloriesFinales),
      proteines: Math.round(proteines),
      glucides: Math.round(glucides),
      lipides: Math.round(lipides),
      eau: Math.round(eauBase),
      eauLitres: (eauBase / 1000).toFixed(2)
    };

    setResults(res);

    const entry = { date: new Date().toISOString(), formData: { ...formData }, results: res };
    const newHist = [entry, ...historique].slice(0, 20);
    setHistorique(newHist);
    localStorage.setItem('metabolicHistory', JSON.stringify(newHist));
  };

  const supprimerEntree = (idx) => {
    const newHist = historique.filter((_, i) => i !== idx);
    setHistorique(newHist);
    localStorage.setItem('metabolicHistory', JSON.stringify(newHist));
  };

  const chargerEntree = (entry) => {
    setFormData(entry.formData);
    setResults(entry.results);
    setShowHistorique(false);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const formatDate = (iso) => {
    const d = new Date(iso);
    return d.toLocaleDateString('fr-FR', {
      day: '2-digit', month: '2-digit', year: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  };

  const getObjectifIcon = () => {
    if (formData.objectif === 'perte' || formData.objectif === 'perteLente') return <TrendingDown className="w-5 h-5" />;
    if (formData.objectif === 'prise' || formData.objectif === 'priseMasse') return <TrendingUp className="w-5 h-5" />;
    return <Minus className="w-5 h-5" />;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 p-4 pb-20">
      <div className="max-w-2xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-3">
              <div className="bg-blue-500 p-3 rounded-xl">
                <Calculator className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-gray-800">
                  Calculateur M√©tabolique
                </h1>
                <p className="text-gray-600 text-sm">
                  Besoins nutritionnels personnalis√©s
                </p>
              </div>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => setShowRecettes(!showRecettes)}
                className="p-3 bg-green-100 hover:bg-green-200 rounded-xl transition-colors"
                title="Recettes prot√©in√©es"
              >
                <ChefHat className="w-5 h-5 text-green-700" />
              </button>
              <button
                onClick={() => setShowHistorique(!showHistorique)}
                className="p-3 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors"
                title="Historique"
              >
                <History className="w-5 h-5 text-gray-700" />
              </button>
            </div>
          </div>
        </div>

        {/* Recettes prot√©in√©es */}
        {showRecettes && (
          <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <ChefHat className="w-5 h-5 text-green-500" />
              Id√©es recettes prot√©in√©es
            </h2>
            <div className="grid gap-4 max-h-96 overflow-y-auto">
              {recettesProteinees.map((recette, i) => (
                <div key={i} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                  <div className="flex items-start justify-between mb-2">
                    <h3 className="font-semibold text-gray-800">{recette.nom}</h3>
                    <div className="flex gap-2 text-xs">
                      <span className="bg-red-100 text-red-700 px-2 py-1 rounded">{recette.proteines}</span>
                      <span className="bg-orange-100 text-orange-700 px-2 py-1 rounded">{recette.calories}</span>
                    </div>
                  </div>
                  <p className="text-sm text-gray-600 mb-2">
                    <strong>Ingr√©dients:</strong> {recette.ingredients}
                  </p>
                  <p className="text-sm text-gray-600">
                    <strong>Pr√©paration:</strong> {recette.preparation}
                  </p>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Historique */}
        {showHistorique && (
          <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <History className="w-5 h-5 text-blue-500" />
              Historique des mesures
            </h2>
            {historique.length === 0 ? (
              <p className="text-gray-500 text-center py-8">
                Aucune mesure enregistr√©e pour le moment
              </p>
            ) : (
              <div className="space-y-3 max-h-96 overflow-y-auto">
                {historique.map((entree, index) => (
                  <div
                    key={index}
                    className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors"
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1 cursor-pointer" onClick={() => chargerEntree(entree)}>
                        <div className="flex items-center gap-2 mb-2">
                          <Calendar className="w-4 h-4 text-gray-500" />
                          <span className="text-sm font-medium text-gray-700">
                            {formatDate(entree.date)}
                          </span>
                        </div>
                        <div className="grid grid-cols-2 gap-2 text-sm">
                          <div>
                            <span className="text-gray-600">Poids:</span>
                            <span className="font-medium text-gray-800 ml-1">
                              {entree.formData.poids} kg
                            </span>
                          </div>
                          <div>
                            <span className="text-gray-600">Calories:</span>
                            <span className="font-medium text-orange-600 ml-1">
                              {entree.results.caloriesJour} kcal
                            </span>
                          </div>
                          <div>
                            <span className="text-gray-600">Prot√©ines:</span>
                            <span className="font-medium text-red-600 ml-1">
                              {entree.results.proteines}g
                            </span>
                          </div>
                          <div>
                            <span className="text-gray-600">Eau:</span>
                            <span className="font-medium text-cyan-600 ml-1">
                              {entree.results.eauLitres}L
                            </span>
                          </div>
                        </div>
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          supprimerEntree(index);
                        }}
                        className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                        title="Supprimer"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Formulaire */}
        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <User className="w-5 h-5 text-blue-500" />
            Informations personnelles
          </h2>
          
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  √Çge (ans)
                </label>
                <input
                  type="number"
                  name="age"
                  value={formData.age}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="30"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Sexe
                </label>
                <select
                  name="sexe"
                  value={formData.sexe}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="homme">Homme</option>
                  <option value="femme">Femme</option>
                </select>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Taille (cm)
                </label>
                <input
                  type="number"
                  name="taille"
                  value={formData.taille}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="175"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Poids (kg)
                </label>
                <input
                  type="number"
                  name="poids"
                  value={formData.poids}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="70"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Masse musculaire (kg)
                </label>
                <input
                  type="number"
                  step="0.1"
                  name="masseMusculaire"
                  value={formData.masseMusculaire}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="30"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Masse osseuse (kg)
                </label>
                <input
                  type="number"
                  step="0.1"
                  name="masseOsseuse"
                  value={formData.masseOsseuse}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="3.5"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Masse hydrique (%)
                </label>
                <input
                  type="number"
                  step="0.1"
                  name="masseHydrique"
                  value={formData.masseHydrique}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="55"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Masse graisseuse (%)
                </label>
                <input
                  type="number"
                  step="0.1"
                  name="masseGraisseuse"
                  value={formData.masseGraisseuse}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="20"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Graisse visc√©rale (niveau)
                </label>
                <input
                  type="number"
                  name="graisseViscerale"
                  value={formData.graisseViscerale}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="8"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  √Çge m√©tabolique (ans)
                </label>
                <input
                  type="number"
                  name="ageMetabolique"
                  value={formData.ageMetabolique}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="28"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <Target className="w-4 h-4 text-blue-500" />
                Objectif
              </label>
              <select
                name="objectif"
                value={formData.objectif}
                onChange={handleChange}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="perte">Perte de poids rapide (-500 kcal)</option>
                <option value="perteLente">Perte de poids progressive (-300 kcal)</option>
                <option value="maintien">Maintien du poids</option>
                <option value="prise">Prise de masse musculaire (+300 kcal)</option>
                <option value="priseMasse">Prise de masse rapide (+500 kcal)</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Niveau d'activit√© physique
              </label>
              <select
                name="activite"
                value={formData.activite}
                onChange={handleChange}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="sedentaire">S√©dentaire (peu ou pas d'exercice)</option>
                <option value="leger">L√©ger (1-3 jours/semaine)</option>
                <option value="modere">Mod√©r√© (3-5 jours/semaine)</option>
                <option value="intense">Intense (6-7 jours/semaine)</option>
                <option value="treIntense">Tr√®s intense (2x/jour)</option>
              </select>
            </div>
          </div>

          <button
            onClick={calculerBesoins}
            className="w-full mt-6 bg-gradient-to-r from-blue-500 to-green-500 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-green-600 transition-all shadow-md"
          >
            Calculer mes besoins
          </button>
        </div>

        {/* R√©sultats */}
        {results && (
          <div className="bg-white rounded-2xl shadow-lg p-6">
            <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              {getObjectifIcon()}
              Vos besoins nutritionnels quotidiens
            </h2>

            <div className="grid gap-4">
              <div className="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-xl">
                <div className="text-sm text-orange-700 font-medium mb-1">
                  Calories totales
                </div>
                <div className="text-3xl font-bold text-orange-600">
                  {results.caloriesJour} <span className="text-lg">kcal</span>
                </div>
                <div className="text-xs text-orange-600 mt-1">
                  M√©tabolisme de base: {results.mb} kcal
                </div>
              </div>

              <div className="grid grid-cols-3 gap-3">
                <div className="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl">
                  <div className="text-xs text-red-700 font-medium mb-1">
                    Prot√©ines
                  </div>
                  <div className="text-2xl font-bold text-red-600">
                    {results.proteines}g
                  </div>
                  <div className="text-xs text-red-600 mt-1">
                    {Math.round((results.proteines * 4 / results.caloriesJour) * 100)}% cal
                  </div>
                </div>

                <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl">
                  <div className="text-xs text-blue-700 font-medium mb-1">
                    Glucides
                  </div>
                  <div className="text-2xl font-bold text-blue-600">
                    {results.glucides}g
                  </div>
                  <div className="text-xs text-blue-600 mt-1">
                    {Math.round((results.glucides * 4 / results.caloriesJour) * 100)}% cal
                  </div>
                </div>

                <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-xl">
                  <div className="text-xs text-yellow-700 font-medium mb-1">
                    Lipides
                  </div>
                  <div className="text-2xl font-bold text-yellow-600">
                    {results.lipides}g
                  </div>
                  <div className="text-xs text-yellow-600 mt-1">
                    {Math.round((results.lipides * 9 / results.caloriesJour) * 100)}% cal
                  </div>
                </div>
              </div>

              <div className="bg-gradient-to-r from-cyan-50 to-cyan-100 p-4 rounded-xl border-2 border-cyan-200">
                <div className="flex items-center gap-2 mb-2">
                  <Droplets className="w-5 h-5 text-cyan-600" />
                  <div className="text-sm text-cyan-700 font-medium">
                    Hydratation recommand√©e
                  </div>
                </div>
                <div className="text-3xl font-bold text-cyan-600">
                  {results.eauLitres} <span className="text-lg">litres</span>
                </div>
                <div className="text-sm text-cyan-700 mt-2">
                  Soit {results.eau} ml ou environ {Math.round(results.eau / 250)} verres d'eau par jour
                </div>
                <div className="mt-3 pt-3 border-t border-cyan-200">
                  <div className="text-xs text-cyan-700 space-y-1">
                    <div>‚Ä¢ Base: {Math.round(parseFloat(formData.poids) * 35)} ml (35ml/kg)</div>
                    <div>‚Ä¢ Activit√© physique: +{({
                      sedentaire: 0,
                      leger: 300,
                      modere: 500,
                      intense: 800,
                      treIntense: 1200
                    })[formData.activite]} ml</div>
                    {(formData.objectif === 'perte' || formData.objectif === 'perteLente') && (
                      <div>‚Ä¢ Perte de poids: +250 ml</div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            <div className="mt-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
              <p className="text-sm text-blue-800">
                <strong>üí° Conseil:</strong> Ces valeurs sont des estimations personnalis√©es. 
                Consultez les recettes prot√©in√©es ci-dessus pour atteindre vos objectifs !
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}